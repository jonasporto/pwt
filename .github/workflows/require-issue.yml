name: Require Issue for PR

on:
  pull_request_target:
    types: [opened, edited]

permissions:
  pull-requests: write
  issues: write

jobs:
  check-issue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const author = pr.user.login;

            // Skip check for repo owner and collaborators
            const { data: permissionLevel } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: author
            });

            if (['admin', 'write'].includes(permissionLevel.permission)) {
              console.log(`Skipping check for ${author} (${permissionLevel.permission} access)`);
              return;
            }

            const body = pr.body || '';

            // Look for issue references: #123, fixes #123, closes #123, etc.
            const issuePattern = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*#(\d+)|#(\d+)/gi;
            const matches = body.match(issuePattern);

            if (!matches) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `Thanks for your interest in contributing!

            This project requires PRs to be linked to an existing Issue.

            **Please:**
            1. Open an Issue describing the proposed change
            2. Wait for feedback/approval from maintainers
            3. Then open a PR referencing the issue (e.g., \`Fixes #123\`)

            This helps us avoid duplicate work and align expectations before code is written.

            Closing this PR automatically.`
              });

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                state: 'closed'
              });

              core.setFailed('PR must reference an issue');
              return;
            }

            // Verify the referenced issue exists and is valid
            const issueNumbers = [...new Set(
              matches.map(m => m.match(/\d+/)[0])
            )];

            for (const num of issueNumbers) {
              try {
                const issue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(num)
                });

                // Check it's an issue (not another PR)
                if (!issue.data.pull_request) {
                  console.log(`Valid issue #${num} found`);
                  return; // Valid issue found, allow PR
                }
              } catch (e) {
                // Issue doesn't exist
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `The referenced issue was not found or is not valid.

            Please open an Issue first, then reference it in your PR.`
            });

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              state: 'closed'
            });

            core.setFailed('Referenced issue not found');
